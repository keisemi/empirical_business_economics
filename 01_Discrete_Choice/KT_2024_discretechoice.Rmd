---
title: "KinokoTakenoko_2024_logit"
author: "YumaIshino"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
    code_folding: hide
    number_section: true
date: "2024-05-12"
---
　このファイルは、2024年度のきのこの山・たけのこの里アンケートについての分析用のコード及びその結果をまとめたものである。
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
```{r}

library("tidyverse")
library("knitr")
library("magrittr")
library("mlogit") # ロジットモデル推定のためのパッケージ
library("stargazer") # 推定結果の表作成
KT_2024 <- read_csv("KinokoTakenokoSurvey_raw.csv")

new_col_name <- c("ID","experience", "Q1", "Q2", "Q3", "Q4", "Q5", "age", "gender", "region", "familyhouse") # 列名変更用

data_for_estimation <- KT_2024 %>%
  mutate(ID = row_number()) %>%　# 適当にIDを定義
  select(ID, c(8:17)) %>% # 必要な変数のみ選択
  set_colnames(new_col_name) %>% #列名を変更
  filter(experience != "4 : 食べたことがない" & gender != "3 : 回答したくない") %>% # 分析上扱いにくいデータを除外
  drop_na() # NA(未回答？)の行を除外

data_for_estimation %>% 
  gather(key = "occasion", value = choice, starts_with("Q")) -> data_for_estimation

pricedata <- 
  data.frame( occasion = c("Q1","Q2", "Q3", "Q4", "Q5" ), 
              price_0 = numeric(5), 
              price_1 = c(200, 180, 200, 220, 190 ), 
              price_2 = c(200, 200, 170, 200, 210 ) ) # 提示される価格の組み合わせ
pricedata <- as_tibble(pricedata)

data_for_estimation %>% 
  left_join(pricedata) %>%
  arrange(ID, occasion) -> data_for_estimation

data_for_estimation %>% 
  mutate( Kinoko_0 = 0, 
          Kinoko_1 = 1, 
          Kinoko_2 = 0, 
          Takenoko_0 = 0, 
          Takenoko_1 = 0, 
          Takenoko_2 = 1   ) %>%
  arrange(ID, occasion) -> data_for_estimation

data_for_estimation %>% 
  mutate( choice =  case_when(choice == "1 : きのこの山を買う" ~ 1, 
                              choice == "2 : たけのこの里を買う" ~ 2, 
                              choice == "3 : どちらも買わない" ~ 0 ),
          gender =　case_when(gender == "1 : 男性" ~ "0", 
                              gender == "2 : 女性" ~ "female" ),
          exp    =  case_when(experience == "1 : 過去半年以内" ~ "halfyear", 
                              experience == "2 : 過去半年から１年以内" ~ "half_to_1year", 
                              experience == "3 : １年以上前" ~ "0" ),
          adult = if_else(age>=20, 1, 0),
          region =  case_when(region == "1 : 北海道地方" ~ "_Kanto", 
                              region == "2 : 東北地方" ~ "_Kanto", 
                              region == "3 : 関東地方" ~ "_Kanto" ,
                              region == "4 : 中部地方" ~ "_Kanto",
                              region == "5 : 近畿地方" ~ "Kansai",
                              region == "6 : 中国地方" ~ "Kansai",
                              region == "7 : 四国地方" ~ "Kansai",
                              region == "8 : 九州地方(沖縄含む)" ~ "Kansai",
                              region == "9 : 海外" ~ "Oversea",
          )
  ) -> data_for_estimation

data_for_estimation$choiceid <- 1:nrow(data_for_estimation)

datalogit <- dfidx(data = as.data.frame(data_for_estimation),
                   choice = "choice", 
                   varying = c(9:17), 
                   sep = "_",
                   idx = list(c("choiceid", "ID")), 
                   idnames = c("chid", "alt"),
                   opposite = c("price")) # 分析用のデータフレーム作成

no_atr <- formula(choice ~ price + Kinoko+ Takenoko | 0)
with_atr <- formula(choice ~price+Kinoko+Takenoko+ price:gender+Takenoko:gender+Kinoko:gender+price:familyhouse+Takenoko:familyhouse+Kinoko:familyhouse+price:adult+Takenoko:adult+Kinoko:adult+price:region+Takenoko:region+Kinoko:region | 0 | 0) # 式が長いので事前に格納

# 分析
ml <- mlogit(formula = no_atr,
             reflevel = '0',
             data = datalogit)
rcdc <- mlogit(formula = no_atr, 
               data = datalogit, 
               panel = TRUE, 
               rpar = c(price = "ln", Kinoko = "n", Takenoko = "n") , 
               R = 2000, 
               correlation = FALSE)
ml_consumer_atr <- mlogit(formula = with_atr, 
                          data = datalogit,reflevel = '0')
rcdc_consumer_atr <- mlogit(formula = with_atr, 
                            data = datalogit, 
                            panel = TRUE, 
                            rpar = c(price = "ln", Kinoko = "n", Takenoko = "n") , 
                            R = 2000, 
                            correlation = FALSE) 

```
　以下に、(1):消費者属性を入れない多項ロジット、(2):消費者属性を入れないランダム係数ロジット、(3):消費者属性を入れた多項ロジット、(4):消費者属性を入れたランダム係数ロジットのそれぞれの分析結果を並べた表を示す。
```{r, results = "asis"}
# 表
stargazer::stargazer(ml,rcdc,ml_consumer_atr,rcdc_consumer_atr,column.labels=c("mlogit","rcdc","mlogit","rcdc"),single.row=TRUE,type="html",align = TRUE)

```
　成人であると価格に反応しやすく、購入確率が低い傾向にあることが示唆される。また、女性である場合は価格に反応しにくく、購入確率が高い傾向にあることもわかる。



　また、参考までに以下に2023年のデータで同様の分析を実行した際の結果を示しておく。概ね結果は同じであるが、女性ダミーの交差項の係数に関しては結果が異なるので確認されたい。
![](2023_KT_table.png){width=75%}
