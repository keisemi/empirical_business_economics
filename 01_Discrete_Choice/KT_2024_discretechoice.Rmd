---
title: "KinokoTakenoko_2024_logit"
author: "YumaIshino"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
    code_folding: hide
    number_section: true
date: "2024-06-01"
---
　このファイルは、2024年度のきのこの山・たけのこの里アンケートについての分析用のコード及びその結果をまとめたものである。
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
```{r}

library("tidyverse")
library("knitr")
library("magrittr")
library("mlogit") # ロジットモデル推定のためのパッケージ
library("stargazer")# 推定結果の表作成
library(kableExtra)
KT_2024 <- read_csv("KinokoTakenokoSurvey_raw.csv")

new_col_name <- c("ID","experience", "Q1", "Q2", "Q3", "Q4", "Q5", "age", "gender", "region", "familyhouse") # 列名変更用

KT_2024 <- KT_2024 %>%
  mutate(ID = row_number()) %>%　# 適当にIDを定義
  select(ID, c(8:17)) %>% # 必要な変数のみ選択
  set_colnames(new_col_name) %>% #列名を変更
  filter(experience != "4 : 食べたことがない" & gender != "3 : 回答したくない") %>% # 分析上扱いにくいデータを除外
  drop_na() # NA(未回答？)の行を除外
```
以下は提示された価格の組み合わせに対してきのこの山とたけのこの里のどちらを選択したか、あるいはどちらも選択しなかったかの比率を表したものである。比較的たけのこの里のほうが買われやすいことや、価格が高いと購入しない確率が高くなることなどが見て取れる。
```{r}
N <- length(KT_2024$ID)

# 回答数の比率を表にするためのデータ整形
KT_2024 %>%
  select(ID, Q1, Q2, Q3, Q4, Q5)  %>% # IDと回答のみ抽出
  gather(key = Q, value  = choice, Q1, Q2, Q3, Q4, Q5) -> datafig

datafig %>% 
    mutate( Q = ifelse(Q == "Q1", "Q1: (200円, 200円)" ,Q),  
            Q = ifelse(Q == "Q2", "Q2: (180円, 200円)" ,Q),  
            Q = ifelse(Q == "Q3", "Q3: (200円, 170円)" ,Q),  
            Q = ifelse(Q == "Q4", "Q4: (220円, 200円)" ,Q),  
            Q = ifelse(Q == "Q5", "Q5: (190円, 210円)" ,Q) ) -> datafig # 対応する選択肢に置き換える

datafig %>% 
    group_by(Q, choice) %>% 
    tally() %>% 
    mutate( n = n/N) %>% 
    pivot_wider( id_cols = "Q", names_from = "choice", values_from = "n") %>%
    knitr::kable( digits = 2) -> tab_choice # 表作成

tab_choice

datafig %>% 
    group_by(Q, choice) %>% 
    tally() %>% 
    mutate( n = n/N) %>% 
    pivot_wider( id_cols = "Q", names_from = "choice", values_from = "n") %>%
    knitr::kable( digits = 2, "latex") %>%
    save_kable("output/choice_table.tex") # tex形式で保存
```


以下は回答者の属性の比率である。
```{r}

# 回答者の属性の比率を表にするためのデータ整形
data_atr <- KT_2024 %>%
  mutate(gender =　case_when(gender == "1 : 男性" ~ "男性", 
                             gender == "2 : 女性" ~ "女性" ),
          exp    =  case_when(experience == "1 : 過去半年以内" ~ "過去半年以内", 
                              experience == "2 : 過去半年から１年以内" ~ "過去半年から１年以内", 
                              experience == "3 : １年以上前" ~ "１年以上前"),
          adult = if_else(age>=20, "成人", "未成年"),
    region =  case_when(region == "1 : 北海道地方" ~ "関東", 
                              region == "2 : 東北地方" ~ "関東", 
                              region == "3 : 関東地方" ~ "関東" ,
                              region == "4 : 中部地方" ~ "関東",
                              region == "5 : 近畿地方" ~ "関西",
                              region == "6 : 中国地方" ~ "関西",
                              region == "7 : 四国地方" ~ "関西",
                              region == "8 : 九州地方(沖縄含む)" ~ "関西",
                              region == "9 : 海外" ~ "海外"),
    familyhouse = if_else(familyhouse==1,"実家暮らし","実家暮らしでない"))


data_atr %>%
  group_by(region) %>%
  tally() %>%
  mutate(割合 = n/N) %>% 
  select (-n) %>%
  mutate(変数 = c("出身地方","","")) %>%
  rename(属性 = region) %>%
  select(変数, everything()) ->region_fig



# data_atr %>%
#   group_by(exp) %>%
#   tally() %>%
#   mutate( "割合" = n/N) %>% 
#   pivot_wider(  names_from = "exp", values_from = "n") %>% 
#   mutate("食事経験" = " ") %>%
#   select("食事経験", everything()) ->exp_fig

data_atr %>%
  group_by(gender) %>%
  tally() %>%
  mutate( 割合 = n/N) %>% 
  select(-n) %>%
  mutate(変数 = c("性別","")) %>%
  rename(属性 = gender) %>%
  select(変数, everything()) ->gender_fig
data_atr %>%
  group_by(familyhouse) %>%
  tally() %>%
  mutate( "割合" = n/N) %>% 
  select(-n) %>%
  mutate("変数" = c("実家暮らしかどうか","")) %>%
  rename(属性 = familyhouse) %>%
  select(変数, everything(),) ->　fam_fig

data_atr %>%
  group_by(adult) %>%
  tally() %>%
  mutate( 割合 = n/N) %>% 
  select(-n) %>%
  mutate(変数 = c("成人かどうか","")) %>%
  rename(属性 = adult) %>%
  select(変数, everything()) ->adult_fig

rbind(gender_fig,adult_fig, fam_fig, region_fig)  %>%
  knitr::kable( digits = 2) -> tab_atr

tab_atr

rbind(gender_fig,adult_fig, fam_fig, region_fig)  %>%
  knitr::kable( digits = 2, "latex",linesep = c("", "\\addlinespace","", "\\addlinespace","","\\addlinespace","","","\\addlinespace"),
                booktabs = TRUE) %>%
  save_kable("output/characteristics_table.tex")
```
```{r}
# 分析用のデータ整形
KT_2024 %>% 
  gather(key = "occasion", value = choice, starts_with("Q")) -> data_for_estimation

pricedata <- 
  data.frame( occasion = c("Q1","Q2", "Q3", "Q4", "Q5" ), 
              price_0 = numeric(5), 
              price_1 = c(200, 180, 200, 220, 190 ), 
              price_2 = c(200, 200, 170, 200, 210 ) ) # 提示される価格の組み合わせ
pricedata <- as_tibble(pricedata)

data_for_estimation %>% 
  left_join(pricedata) %>%
  arrange(ID, occasion) -> data_for_estimation

data_for_estimation %>% 
  mutate( Kinoko_0 = 0, 
          Kinoko_1 = 1, 
          Kinoko_2 = 0, 
          Takenoko_0 = 0, 
          Takenoko_1 = 0, 
          Takenoko_2 = 1   ) %>%
  arrange(ID, occasion) -> data_for_estimation

data_for_estimation %>% 
  mutate( choice =  case_when(choice == "1 : きのこの山を買う" ~ 1, 
                              choice == "2 : たけのこの里を買う" ~ 2, 
                              choice == "3 : どちらも買わない" ~ 0 ),
          gender =　case_when(gender == "1 : 男性" ~ "0", 
                              gender == "2 : 女性" ~ "female" ),
          exp    =  case_when(experience == "1 : 過去半年以内" ~ "halfyear", 
                              experience == "2 : 過去半年から１年以内" ~ "half_to_1year", 
                              experience == "3 : １年以上前" ~ "0" ),
          adult = if_else(age>=20, 1, 0),
          region =  case_when(region == "1 : 北海道地方" ~ "_Kanto", 
                              region == "2 : 東北地方" ~ "_Kanto", 
                              region == "3 : 関東地方" ~ "_Kanto" ,
                              region == "4 : 中部地方" ~ "_Kanto",
                              region == "5 : 近畿地方" ~ "Kansai",
                              region == "6 : 中国地方" ~ "Kansai",
                              region == "7 : 四国地方" ~ "Kansai",
                              region == "8 : 九州地方(沖縄含む)" ~ "Kansai",
                              region == "9 : 海外" ~ "Oversea",
          )
  ) -> data_for_estimation

data_for_estimation$choiceid <- 1:nrow(data_for_estimation)

datalogit <- dfidx(data = as.data.frame(data_for_estimation),
                   choice = "choice", 
                   varying = c(9:17), 
                   sep = "_",
                   idx = list(c("choiceid", "ID")), 
                   idnames = c("chid", "alt"),
                   opposite = c("price")) # 分析用のデータフレーム作成

no_atr <- formula(choice ~ price + Kinoko+ Takenoko | 0)
with_atr <- formula(choice ~price+Kinoko+Takenoko+ price:gender+Takenoko:gender+Kinoko:gender+price:familyhouse+Takenoko:familyhouse+Kinoko:familyhouse+price:adult+Takenoko:adult+Kinoko:adult+price:region+Takenoko:region+Kinoko:region | 0 | 0) # 式が長いので事前に格納

# 分析
ml <- mlogit(formula = no_atr,
             reflevel = '0',
             data = datalogit)
rcdc <- mlogit(formula = no_atr, 
               data = datalogit, 
               panel = TRUE, 
               rpar = c(price = "n", Kinoko = "n", Takenoko = "n") , 
               R = 2000, 
               correlation = FALSE)
ml_consumer_atr <- mlogit(formula = with_atr, 
                          data = datalogit,reflevel = '0')
rcdc_consumer_atr <- mlogit(formula = with_atr, 
                            data = datalogit, 
                            panel = TRUE, 
                            rpar = c(price = "n", Kinoko = "n", Takenoko = "n") , 
                            R = 2000, 
                            correlation = FALSE) 

```
　以下に、(1):消費者属性を入れない多項ロジット、(2):消費者属性を入れないランダム係数ロジット、(3):消費者属性を入れた多項ロジット、(4):消費者属性を入れたランダム係数ロジットのそれぞれの分析結果を並べた表を示す。


```{r, results = "asis"}
# 表
stargazer::stargazer(ml,rcdc,ml_consumer_atr,rcdc_consumer_atr,column.labels=c("mlogit","rcdc","mlogit","rcdc"),single.row=TRUE,type="html",align = TRUE)

```
　20歳以上であると19歳に比べて価格に反応しやすいことや、購入確率が低い傾向にあることが示唆される。また、女性である場合は男性に比べて価格に反応しにくいことや、購入確率が高い傾向にあることもわかる。



　また、参考までに以下に2023年のデータで同様の分析を実行した際の結果を示しておく。概ね結果は同じであるが、女性ダミーの交差項の係数に関しては結果が異なるので確認されたい。
![](2023_KT_table.png){width=75%}
  
次に、きのこの山、たけのこの里、価格係数の分布を作成していく。


```{r}

# 消費者属性を考慮して選好パラメタおよびWTPの分布の計算

# 全部ダミー変数にする
data_for_param <- KT_2024 %>%
  mutate(gender =　case_when(gender == "1 : 男性" ~ 0,
                            gender == "2 : 女性" ~ 1 ),
         adult = if_else(age>=20, 1, 0),
         kansai =  case_when(region == "1 : 北海道地方" ~ 0,
                             region == "2 : 東北地方" ~ 0,
                             region == "3 : 関東地方" ~ 0 ,
                             region == "4 : 中部地方" ~ 0,
                             region == "5 : 近畿地方" ~ 1,
                             region == "6 : 中国地方" ~ 1,
                             region == "7 : 四国地方" ~ 1,
                             region == "8 : 九州地方(沖縄含む)" ~ 1,
                             region == "9 : 海外" ~ 0),
         oversea =  case_when(region == "1 : 北海道地方" ~ 0,
                             region == "2 : 東北地方" ~ 0,
                             region == "3 : 関東地方" ~ 0 ,
                             region == "4 : 中部地方" ~ 0,
                             region == "5 : 近畿地方" ~ 0,
                             region == "6 : 中国地方" ~ 0,
                             region == "7 : 四国地方" ~ 0,
                             region == "8 : 九州地方(沖縄含む)" ~ 0,
                             region == "9 : 海外" ~ 1))

indiv_par <- rcdc_consumer_atr$indpar
# 各個人の属性のパラメータを計算して和を取る→その値と各個人の選好パラメタ(消費者属性を考慮していない)との和を取る
param_Takenoko_atr <- data_for_param$gender*rcdc_consumer_atr$coefficients[5]+data_for_param$familyhouse*rcdc_consumer_atr$coefficients[8]+data_for_param$adult*rcdc_consumer_atr$coefficients[11]+data_for_param$kansai*rcdc_consumer_atr$coefficients[15]+data_for_param$oversea*rcdc_consumer_atr$coefficients[16]
alpha_Takenoko_by_indiv <- indiv_par$Takenoko + param_Takenoko_atr

param_Kinoko_atr <- data_for_param$gender*rcdc_consumer_atr$coefficients[6]+data_for_param$familyhouse*rcdc_consumer_atr$coefficients[9]+data_for_param$adult*rcdc_consumer_atr$coefficients[12]+data_for_param$kansai*rcdc_consumer_atr$coefficients[17]+data_for_param$oversea*rcdc_consumer_atr$coefficients[18]
alpha_Kinoko_by_indiv <- indiv_par$Kinoko + param_Kinoko_atr


param_price_atr <- data_for_param$gender*rcdc_consumer_atr$coefficients[4]+data_for_param$familyhouse*rcdc_consumer_atr$coefficients[7]+data_for_param$adult*rcdc_consumer_atr$coefficients[10]+data_for_param$kansai*rcdc_consumer_atr$coefficients[13]+data_for_param$oversea*rcdc_consumer_atr$coefficients[14]
beta_price_by_indiv <- indiv_par$price + param_price_atr
```
きのこの山とたけのこの里の係数の差の分布は以下のようになる。きのこよりもたけのこがより好まれていることが見て取れる。
```{r}

# きのことたけのこの係数の差の分布
KT_dist <- ggplot(data = data.frame(x = c(-25, 25)), aes(x)) +
  stat_function(fun = dnorm, n = 101, 
                args = list(mean = mean(alpha_Kinoko_by_indiv) -mean(alpha_Takenoko_by_indiv) , 
                            sd = sqrt(var(alpha_Kinoko_by_indiv) + var(alpha_Takenoko_by_indiv)) ) ) +
  ylab("density") + xlab("Kinoko - Takenoko") +
  ggtitle("Preference Kinoko over Takenoko")
plot(KT_dist)

ggsave(filename = "output/fig_dist_preference_KT.pdf", plot = KT_dist, width = 6, height = 6)
```
続いて、以下が価格係数の分布である。
```{r}
# 価格係数の分布
p_coef_dist <- ggplot(data = data.frame(x = c(0.05, 0.30) ), aes(x)) +
  stat_function(fun = dnorm, n = 101, 
                args = list(mean = mean(beta_price_by_indiv), sd = sd(beta_price_by_indiv)), colour = "red" ) + 
  ylab("density") + xlab("beta") +
  scale_y_continuous(breaks = NULL) + ggtitle("Beta (price coefficient)")
plot(p_coef_dist)
ggsave(filename = "output/fig_dist_price_coef.pdf", plot = p_coef_dist, width = 6, height = 6)
```

次に、WTPの分布を作成する。
```{r}
# WTPを求める
# ドロー元の分布のパラメタ
dist_Kinoko <- rpar(rcdc_consumer_atr,'Kinoko')
dist_Takenoko <- rpar(rcdc_consumer_atr,'Takenoko')
dist_price <- rpar(rcdc_consumer_atr,'price')
alpha_Kinoko_for_WTP <- NULL
alpha_Takenoko_for_WTP <- NULL
beta_price_for_WTP <- NULL
# 各消費者(計236人)ごとにランダムな選好を100回ドローする→上で計算した属性のパラメタの和との和を取る
for(i in 1:236){
set.seed(100+i)

alpha_Kinoko_draw = rnorm(100, mean = dist_Kinoko$mean, sd = abs(dist_Kinoko$sigma))+param_Kinoko_atr[i]
alpha_Kinoko_for_WTP = c(alpha_Kinoko_for_WTP, alpha_Kinoko_draw)

alpha_Takenoko_draw = rnorm(100, mean = dist_Takenoko$mean, sd = abs(dist_Takenoko$sigma))+param_Takenoko_atr[i]
alpha_Takenoko_for_WTP = c(alpha_Takenoko_for_WTP, alpha_Takenoko_draw)

beta_price_draw = rnorm(100, mean = dist_price$mean, sd = abs(dist_price$sigma))+param_price_atr[i]
beta_price_for_WTP = c(beta_price_for_WTP, beta_price_draw)
}

# データフレーム化
dt_brand = 
  tibble( alpha_Kinoko_for_WTP , 
          alpha_Takenoko_for_WTP ,  
          beta_price_for_WTP)

# 支払い意思額の計算
dt_brand %>% 
  mutate( brand_Kinoko = alpha_Kinoko_for_WTP / beta_price_for_WTP, 
          brand_Takenoko = alpha_Takenoko_for_WTP / beta_price_for_WTP,
          love_Kinoko = ifelse(alpha_Kinoko_for_WTP > alpha_Takenoko_for_WTP, 1, 0 )) -> dt_brand 


dt_brand %>% 
  select( brand_Kinoko, brand_Takenoko) %>% 
  rename( WTP_Kinoko = brand_Kinoko, 
          WTP_Takenoko = brand_Takenoko) %>% 
  pivot_longer( cols = everything(), names_to = "Name", values_to = "WTP") -> dt
```

以下がWTPの分布となる。安い場合はきのこのほうが買われやすいことが示唆される。
```{r}
# WTPの分布
dt %>% 
  ggplot( aes(x = WTP, colour  = Name)) + theme_bw() + 
  geom_density() +
  xlim(c(0,500))-> fig_brand
plot(fig_brand)
ggsave(filename = "output/brand_value.pdf", plot = fig_brand, width = 12, height = 6)

```

