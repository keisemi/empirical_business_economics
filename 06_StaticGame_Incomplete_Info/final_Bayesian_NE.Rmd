---
title: "Untitled"
author: "Shinji Koiso"
date: "2024-06-09"
output: html_document
---

#0.preparation
```{r}
library(tidyverse)

#data
y = read.csv("../../airline_data/greco/y.csv")
x_ANA = read.csv("../../airline_data/greco/x_ANA.csv")
x_JAL = read.csv("../../airline_data/greco/x_JAL.csv")


#whether two dfs are identical
identical(select(x_JAL,-Flight), select(x_JAL,-Flight))
#True

#merge
df = y %>%
  #market index
  mutate(id = 1:n()) %>% 
  bind_cols(x_ANA %>% 
              #rename company-specific columns
              rename(Flight_ANA = Flight) 
              ) %>% 
  bind_cols(x_JAL %>%
              #rename company-specific columns
              rename(Flight_JAL = Flight) %>% 
              select(Flight_JAL)) %>% 
  relocate(id)
```


```{r}
#descriptive statistics
df %>% 
  select(y_ANA,y_JAL,Distance:Flight_JAL) %>% 
  summarise_all(mean) %>% 
  bind_rows(
    df %>% 
      select(y_ANA,y_JAL,Distance:Flight_JAL) %>% 
  summarise_all(sd)
  ) %>% 
  `rownames<-`( c("Mean","SD")) %>% 
  t() %>% 
  as.data.frame() %>% 
  #日本語
  `rownames<-`(c("y_ANA","y_JAL","距離","人口","人口2乗","新幹線","フライトANA","フライトJAL")) %>%
  xtable::xtable()
```


#1. 1st stage 
1st stage specification
1. polynomial
2. spline
3. logit 
```{r}
#1. polynomial

#ANA
r_sq_vec = tibble()

for(i in 1:5){
  model = df %>% 
    lm(y_ANA ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=i,raw=F) ,data=.) %>% 
    summary()
  
  r_sq_vec = r_sq_vec %>% 
    bind_rows(tibble(degree = i,Rsq = model$adj.r.squared))
}


#JAL
r_sq_vec2 = tibble()

for(i in 1:5){
  model = df %>% 
    lm(y_JAL ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=i,raw=F) ,data=.) %>% 
    summary()
  
  r_sq_vec2 = r_sq_vec2 %>% 
    bind_rows(tibble(degree = i,Rsq = model$adj.r.squared))
}

r_sq_vec %>% 
  mutate(comp = "ANA") %>% 
  bind_rows(
    r_sq_vec2 %>% mutate(comp = "JAL")
  ) %>% 
  ggplot(aes(degree,Rsq,col = comp))+
  geom_line()+
  geom_point()

#max degree = 9
```
```{r}
#what degree is better?
#cross-validation
set.seed(825)

K = 10
df = df %>% 
  mutate(k_id = ceiling(runif(nrow(df))*K))

df %>% 
  count(k_id)




#prediction performance
#install.packages("ROCR")
library(ROCR)
AUC <- function(s, Y){
  pred <- ROCR::prediction(s, Y)
  auc <- performance(pred, "auc")@y.values[[1]] 
  return(auc)
}

degrees = 1:4
AUCs1 = matrix(0,nrow = K,ncol = length(degrees))
AUCs2 = AUCs1
MAE1 = AUCs1
MAE2 = AUCs1
AIC1 = AUCs1
AIC2 = AUCs1
BIC1 = AUCs1
BIC2 = AUCs1


for(i in 1:length(degrees)){
  for(k in 1:K){
    model1 = df %>% 
      filter(k_id != k) %>% 
      lm(y_ANA ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=i) ,data=.)
    
    model2 = df %>% 
      filter(k_id != k) %>% 
      glm(y_ANA ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=i) ,family = binomial,data = .)
    
    s1 = df %>% 
      filter(k_id == k) %>% 
      mutate(pred = predict(model1, newdata = .,type = "response"),
             pred = pmax(pmin(pred,1),0)
             ) %>% 
      pull(pred)
    
    s2 = df %>% 
      filter(k_id == k) %>% 
      predict(model2, newdata = .,type = "response")
    
    if(i < 4){
      AUCs1[k,i] = AUC(s1,df %>% filter(k_id == k) %>% pull(y_ANA))
      AUCs2[k,i] = AUC(s2,df %>% filter(k_id == k) %>% pull(y_ANA))
    }
    
    
    MAE1[k,i] = mean(abs(s1 - (df %>% filter(k_id == k) %>% pull(y_ANA))))
    MAE2[k,i] = mean(abs(s2- (df %>% filter(k_id == k) %>% pull(y_ANA))))
    
    AIC1[k,i] = AIC(model1)
    AIC2[k,i] = AIC(model2)
    
    BIC1[k,i] = BIC(model1)
    BIC2[k,i] = BIC(model2)
  }
}


```



```{r}
#2. B-spline
library(splines)

vec = c("Distance","Population","Flight_ANA","Flight_JAL")
# s_vec = c()
# for(i in 1:(length(vec))){
#   l_v = vec[i]
#   for(j in 1:(length(vec)-i+1)){
#     r_v = vec[i + j - 1]
#     df[paste(l_v,r_v,sep = "_")] = pull(df[l_v])*pull(df[r_v])
#     s_vec = c(s_vec,paste(l_v,r_v,sep = "_"))
#   }
# }

#bs


# bs_formula1 = function(var,degree){
#   #var: variable name (string type)
#   return(paste0("bs(",var,",knots = c(quantile(",var,",.25),quantile(",var,",.5),quantile(",var,",.75)), degree = ",degree,")+"))
# }

bs_formula1 = function(var,degree){
  #var: variable name (string type)
  return(paste0("bs(",var,",knots = c(quantile(",var,",.5)), degree = ",degree,")+"))
}

bs_formula = function(var,comp,degree){
  #var: variable name (string type)
  #comp = "ANA","JAL"
  formula1 = paste0("y_",comp," ~Train*(")
  for(i in var){
    formula1 = paste0(formula1,bs_formula1(i,degree))
  }
  formula1 = str_sub(formula1,end =-2)
  formula1 = paste0(formula1,")")
  
  formula1 = as.formula(formula1)

  return(formula1)
}

degrees = 1:3
AUCs1_bs = matrix(0,nrow = K,ncol = length(degrees))
AUCs2_bs = AUCs1_bs
MAE1_bs = AUCs1_bs
MAE2_bs = AUCs1_bs
AIC1_bs = AUCs1_bs
AIC2_bs = AUCs1_bs
BIC1_bs = AUCs1_bs
BIC2_bs = AUCs1_bs


for(i in 1:length(degrees)){
  for(k in 1:K){
    if(i == 1){
      var_i = vec
    } 
    # else{
    #   var_i = c(vec,s_vec)
    # }
    
    model1 = df %>% 
      filter(k_id != k) %>% 
      lm(bs_formula(var_i,"ANA",degree = i),data=.)
    
    model2 = df %>% 
      filter(k_id != k) %>% 
      glm(bs_formula(var_i,"ANA",degree = i) ,family = binomial,data = .)
    
    s1 = df %>% 
      filter(k_id == k) %>% 
      mutate(pred = predict(model1, newdata = .,type = "response"),
             pred = pmax(pmin(pred,1),0)
             ) %>% 
      pull(pred)%>% 
      as.vector()
    
    s2 = df %>% 
      filter(k_id == k) %>% 
      predict(model2, newdata = .,type = "response") %>% 
      as.vector()
    
    AUCs1_bs[k,i] = AUC(s1,df %>% filter(k_id == k) %>% pull(y_ANA))
    AUCs2_bs[k,i] = AUC(s2,df %>% filter(k_id == k) %>% pull(y_ANA))
    
    MAE1_bs[k,i] = mean(abs(s1 - (df %>% filter(k_id == k) %>% pull(y_ANA))))
    MAE2_bs[k,i] = mean(abs(s2- (df %>% filter(k_id == k) %>% pull(y_ANA))))
    
    AIC1_bs[k,i] = AIC(model1)
    AIC2_bs[k,i] = AIC(model2)
    
    BIC1_bs[k,i] = BIC(model1)
    BIC2_bs[k,i] = BIC(model2)
  }
}

AUCs1 %>% 
  .[,1:3] %>% 
  data.frame() %>% 
  `colnames<-`(c(paste0("d",1:3))) %>% 
  summarise_all(mean) %>% 
  bind_rows(
    AUCs2 %>% 
      .[,1:3] %>% 
      data.frame() %>% 
      `colnames<-`(c(paste0("d",1:3))) %>% 
      summarise_all(mean)
  ) %>% 
  bind_rows(
    AUCs1_bs %>% 
      data.frame() %>% 
      `colnames<-`(c(paste0("d",1:3))) %>% 
      summarise_all(mean)
  ) %>% 
  bind_rows(
    AUCs2_bs %>% 
      data.frame() %>% 
      `colnames<-`(c(paste0("d",1:3))) %>% 
      summarise_all(mean)
  ) %>% 
  `rownames<-`(c("Linear","Logit","Linear spline","Logit spline"))
#AUC
#linear: degree = 1
```


```{r}
MAE1 %>% 
  data.frame() %>% 
  `colnames<-`(c(paste0("d",1:4))) %>% 
  summarise_all(mean) %>% 
  bind_rows(
    MAE2 %>% 
      data.frame() %>% 
      `colnames<-`(c(paste0("d",1:4))) %>% 
      summarise_all(mean)
  ) %>% 
  bind_rows(
    MAE1_bs %>% 
      data.frame() %>% 
      `colnames<-`(c(paste0("d",1:3))) %>% 
      summarise_all(mean)
  ) %>% 
  bind_rows(
    MAE2_bs %>% 
      data.frame() %>% 
      `colnames<-`(c(paste0("d",1:3))) %>% 
      summarise_all(mean)
  ) %>% 
  `rownames<-`(c("Linear","Logit","Linear spline","Logit spline"))
#MAE
#Logit spline degree = 2
```


```{r}
AIC1 %>%
  data.frame() %>%
  `colnames<-`(c(paste0("d",1:4))) %>%
  summarise_all(mean) %>%
  bind_rows(
    AIC2 %>%
      data.frame() %>%
      `colnames<-`(c(paste0("d",1:4))) %>%
      summarise_all(mean)
  ) %>%
   bind_rows(
    AIC1_bs %>%
      data.frame() %>%
      `colnames<-`(c(paste0("d",1:3))) %>%
      summarise_all(mean)
  ) %>%
  bind_rows(
    AIC2_bs %>%
      data.frame() %>%
      `colnames<-`(c(paste0("d",1:3))) %>%
      summarise_all(mean)
  ) %>%
  `rownames<-`(c("Linear","Logit","Linear spline","Logit spline"))
#AIC
#linear: degree = >7
#logit: degree = 2
```


```{r}
BIC1 %>%
  data.frame() %>%
  `colnames<-`(c(paste0("d",1:4))) %>%
  summarise_all(mean) %>%
  bind_rows(
    BIC2 %>%
      data.frame() %>%
      `colnames<-`(c(paste0("d",1:4))) %>%
      summarise_all(mean)
  ) %>%
   bind_rows(
    BIC1_bs %>%
      data.frame() %>%
      `colnames<-`(c(paste0("d",1:3))) %>%
      summarise_all(mean)
  ) %>%
  bind_rows(
    BIC2_bs %>%
      data.frame() %>%
      `colnames<-`(c(paste0("d",1:3))) %>%
      summarise_all(mean)
  ) %>%
  `rownames<-`(c("Linear","Logit","Linear spline","Logit spline"))


```


```{r}
#1st stage specification1: linear degree 1
m1st_lin_ANA = df %>% 
  lm(y_ANA ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=1) ,data=.)

m1st_lin_JAL = df %>% 
  lm(y_JAL ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=1) ,data=.)

#1st stage specification2: logit with b-spline degree 2
m1st_logit_spline_ANA = df %>% 
  glm(bs_formula(vec,"ANA",degree = 2) ,family = binomial,data = .)

m1st_logit_spline_JAL = df %>% 
  glm(bs_formula(vec,"JAL",degree = 2) ,family = binomial,data = .)

#1st stage specification3: logit degree 1
m1st_logit_ANA = df %>% 
  glm(y_ANA ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=1) ,family = binomial,data = .)

m1st_logit_JAL = df %>% 
  glm(y_JAL ~ Train*poly(Distance,Population,Flight_ANA,Flight_JAL,degree=1),family = binomial,data = .)


df = df %>% 
  mutate(p_lin_ANA = predict(m1st_lin_ANA, newdata = .,type = "response"),
         p_lin_ANA_max = max(ifelse(p_lin_ANA > 1 | p_lin_ANA < 0,NA,p_lin_ANA),na.rm = T),
         p_lin_ANA_min = min(ifelse(p_lin_ANA > 1 | p_lin_ANA < 0,NA,p_lin_ANA),na.rm = T),
         p_lin_ANA = pmax(pmin(p_lin_ANA,p_lin_ANA_max),p_lin_ANA_min),
         p_lin_JAL = predict(m1st_lin_JAL, newdata = .,type = "response"),
         p_lin_JAL_max = max(ifelse(p_lin_JAL > 1 | p_lin_JAL < 0,NA,p_lin_JAL),na.rm = T),
         p_lin_JAL_min = min(ifelse(p_lin_JAL > 1 | p_lin_JAL < 0,NA,p_lin_JAL),na.rm = T),
         p_lin_JAL = pmax(pmin(p_lin_JAL,p_lin_JAL_max),p_lin_JAL_min),
         p_logit_sp_ANA = predict(m1st_logit_spline_ANA, newdata = .,type = "response") ,
         p_logit_sp_JAL = predict(m1st_logit_spline_JAL, newdata = .,type = "response"),
         p_logit_ANA = predict(m1st_logit_ANA, newdata = .,type = "response") ,
         p_logit_JAL = predict(m1st_logit_JAL, newdata = .,type = "response"),
         ) %>% 
  select(-ends_with("max"),-ends_with("min")) 


df_long = df %>% 
  mutate(p_lin_ANA_opp = p_lin_ANA,
         p_lin_JAL_opp = p_lin_JAL,
         p_logit_ANA_opp = p_logit_ANA,
         p_logit_JAL_opp = p_logit_JAL,
         p_logit_sp_ANA_opp = p_logit_sp_ANA,
         p_logit_sp_JAL_opp = p_logit_sp_JAL) %>% 
  pivot_longer(cols = c(p_lin_ANA,p_lin_JAL,
                        p_logit_ANA,p_logit_JAL,
                        p_logit_sp_ANA,p_logit_sp_JAL),values_to = "value")%>% 
  mutate(comp = str_sub(name,start =-3),
         spec = str_sub(name,start =3,end = -5),
         ) %>% 
  select(-name) %>% 
  pivot_wider(values_from = value,names_from = spec) %>% 
  mutate(p_lin_opp = ifelse(comp == "ANA",p_lin_JAL_opp,p_lin_ANA_opp),
         p_logit_opp = ifelse(comp == "ANA",p_logit_JAL_opp,p_logit_ANA_opp),
         p_logit_sp_opp = ifelse(comp == "ANA",p_logit_sp_JAL_opp,p_logit_sp_ANA_opp)) %>% 
  select(-p_lin_JAL_opp,-p_lin_ANA_opp,-p_logit_JAL_opp,-p_logit_ANA_opp,-p_logit_sp_JAL_opp,-p_logit_sp_ANA_opp)
```


```{r}
## results (linear & logit)
texreg::screenreg(list(m1st_lin_ANA,m1st_logit_ANA,m1st_lin_JAL,m1st_logit_JAL),
                  custom.header = list("y_ANA" = 1:2, "y_JAL" = 3:4),
                   custom.model.names = c("linear","logit","linear","logit"),
                  #variable name
                  custom.coef.names = c("Intercept","Train","Distance","Population","Flight_ANA","Flight_JAL","Train:Distance","Train:Population","Train:Flight_ANA","Train:Flight_JAL"))

                    
```

```{r}
#visualization of the first stage
## relationship between Flight and the probability
df %>% 
  summarise_all(mean) %>% 
  select(-Flight_ANA) %>%
  expand_grid(Flight_ANA = seq(min(df$Flight_ANA),max(df$Flight_ANA),0.1)) %>%
  mutate(pred_logit_ANA = predict(m1st_logit_ANA,newdata = .,type = "response"),
         pred_lin_ANA = predict(m1st_lin_ANA,newdata = .,type = "response"),
         pred_lin_ANA = pmin(1,pmax(0,pred_lin_ANA)),
         pred_logit_sp_ANA = predict(m1st_logit_spline_ANA,newdata = .,type = "response"),
         pred_logit_JAL = predict(m1st_logit_JAL,newdata = .,type = "response"),
         pred_lin_JAL = predict(m1st_lin_JAL,newdata = .,type = "response"),
         pred_lin_JAL = pmin(1,pmax(0,pred_lin_JAL)),
         pred_logit_sp_JAL = predict(m1st_logit_spline_JAL,newdata = .,type = "response")
         ) %>%
  pivot_longer(cols = c(pred_logit_ANA,pred_lin_ANA,pred_logit_sp_ANA,pred_logit_JAL,pred_lin_JAL,pred_logit_sp_JAL),values_to = "value") %>%
  mutate(name_comp = str_sub(name,start = -3) %>% paste0("y_",.),
         flight_comp = "FLight_ANA"
         )　%>% 
  rename(Flight = Flight_ANA) %>%
  bind_rows(
    df %>% 
      summarise_all(mean) %>% 
      select(-Flight_JAL) %>%
      expand_grid(Flight_JAL = seq(min(df$Flight_JAL),max(df$Flight_JAL),0.1)) %>%
      mutate(pred_logit_ANA = predict(m1st_logit_ANA,newdata = .,type = "response"),
             pred_lin_ANA = predict(m1st_lin_ANA,newdata = .,type = "response"),
             pred_lin_ANA = pmin(1,pmax(0,pred_lin_ANA)),
             pred_logit_sp_ANA = predict(m1st_logit_spline_ANA,newdata = .,type = "response"),
             pred_logit_JAL = predict(m1st_logit_JAL,newdata = .,type = "response"),
             pred_lin_JAL = predict(m1st_lin_JAL,newdata = .,type = "response"),
             pred_lin_JAL = pmin(1,pmax(0,pred_lin_JAL)),
             pred_logit_sp_JAL = predict(m1st_logit_spline_JAL,newdata = .,type = "response")
             ) %>%
      pivot_longer(cols = c(pred_logit_ANA,pred_lin_ANA,pred_logit_sp_ANA,pred_logit_JAL,pred_lin_JAL,pred_logit_sp_JAL),values_to = "value") %>%
      mutate(name_comp = str_sub(name,start = -3) %>% paste0("y_",.),
         flight_comp = "FLight_JAL"
         ) %>% 
      rename(Flight = Flight_JAL)
  ) %>% 
  mutate(name = str_sub(name,end = -5)) %>% 
  ggplot()+
  geom_line(aes(Flight,value,col = name))+
  facet_wrap(flight_comp~name_comp)+
  labs(y = "y")+
  theme_minimal()
  
```
```{r}
## visualizing the first stage

df %>% 
  pivot_longer(cols = c(p_lin_ANA,p_logit_ANA,p_logit_sp_ANA,y_ANA,
                        p_lin_JAL,p_logit_JAL,p_logit_sp_JAL,y_JAL,
                        ),values_to = "value") %>%
  pivot_longer(cols = c(Flight_ANA,Flight_JAL),values_to = "Flight",names_to = "name_flight") %>%
  mutate(val_comp = str_sub(name,start = -3) %>% paste0("y_",.),
         flight_comp = str_sub(name_flight,start = -3) %>% paste0("Flight_",.),
         y_val = ifelse(str_detect(name,"y_"),value,NA),
         name = str_sub(name,end = -5),
         ) %>%
  ggplot()+
  geom_point(aes(Flight,value,col = name))+
  geom_smooth(aes(Flight,y_val),se = F,col = "red")+
  facet_wrap(flight_comp~val_comp)+
  labs(y = "y")+
  theme_minimal()
```


#2nd stsge
several objectives
1. WOLS: match expected profits
2. moment with IV (GMM): match action
3. MLE


## 1. WOLS: match expected profits

### inversion
```{r}
df_long = df_long %>% 
  mutate(
    Pi_lin = log(lin) - log(1-lin),
    Pi_logit = log(logit) - log(1-logit),
    Pi_logit_sp = log(logit_sp) - log(1-logit_sp)
  )
```

### Recovering the Structural Parameters.
```{r}
df_long = df_long %>%
  mutate(Flight = ifelse(comp == "ANA",Flight_ANA,Flight_JAL),
         Flight_opp = ifelse(comp == "ANA",Flight_JAL,Flight_ANA)
         ) 
         
#linear
est1_1 = df_long %>%
  lm(Pi_lin ~ Train*(Distance + Population + Pop_Square + Train + Flight) + p_lin_opp,data = .) 


#logit
est1_2 = df_long %>%
  lm(Pi_logit ~ Train*(Distance + Population + Pop_Square + Train + Flight) + p_logit_opp,data = .) 

#logit with spline
est1_3 = df_long %>%
  lm(Pi_logit_sp ~ Train*(Distance + Population + Pop_Square + Train + Flight) + p_logit_sp_opp,data = .)

texreg::screenreg(list(est1_1,est1_2,est1_3),
                  #custom.header = list("y_ANA" = 1:2, "y_JAL" = 3:4),
                   custom.model.names = c("linear","logit","logit with spline"),
                  #variable name
                  custom.coef.map = list("(Intercept)" = NA,"Distance" = NA,"Train" = NA,
                                      "Population" = NA,"Flight" = NA,"Pop_Square" = NA,
                                      "Train:Distance" = NA,"Train:Population" = NA,"Train:Flight" = NA,"Train:Pop_Square" = NA,
                                      "p_lin_opp" = "Delta","p_logit_opp" = "Delta","p_logit_sp_opp" = "Delta"))

```


## 2. GMM match action
```{r}

df_long = df_long %>% 
  mutate(y = ifelse(comp == "ANA",y_ANA,y_JAL),
         Distance_Train = Distance*Train,
         Population_Train = Population*Train,
         Pop_Square_Train = Pop_Square*Train,
         Flight_Train = Flight*Train
         ) %>%
  select(-c(y_ANA,y_JAL))

Z = df_long %>% 
  select(Constant, Distance , Population , Pop_Square , Train , Flight , 
          Distance_Train, Population_Train, Pop_Square_Train, Flight_Train,Flight_opp) %>%
  as.matrix()

X_lin = df_long %>% 
  select(Constant, Distance , Population , Pop_Square , Train , Flight , 
         Distance_Train, Population_Train, Pop_Square_Train, Flight_Train, p_lin_opp) %>%
  as.matrix()

X_logit = df_long %>% 
  select(Constant, Distance , Population , Pop_Square , Train , Flight , 
         Distance_Train, Population_Train, Pop_Square_Train, Flight_Train, p_logit_opp) %>% 
  as.matrix()

X_logit_sp = df_long %>% 
  select(Constant, Distance , Population , Pop_Square , Train , Flight , 
         Distance_Train, Population_Train, Pop_Square_Train, Flight_Train, p_logit_sp_opp) %>% 
  as.matrix()

y_ = df_long %>% pull(y)

#moment estimator
moment = function(par,X,Z,y){
  
  p =  1/(1 + exp(- X %*% par))#X %*% par#1/(1 + exp(- X %*% par))

  g = t(Z) %*% (y - p)

  return(g)
}

#standard error
se_moment = function(par,X,Z,y){
  p = 1/(1 + exp(- X %*% par))
  N = nrow(X)
  g = kronecker(t(rep(1,ncol(X))),(p-y)) * Z
  Omega = t(g) %*% g/N
  G = t(Z) %*% (kronecker(t(rep(1,ncol(X))),p*(1-p)) * X )/N
  #just identified
  V = solve(G) %*% Omega %*% t(solve(G)) / N
  
  return(sqrt(diag(V)))
  
}


#install.packages("nleqslv")
library(nleqslv)

param0 = rep(0,ncol(X_lin))
names(param0) = c("(Intercept)","Distance","Population","Pop_Square","Train","Flight",
                  "Train:Distance","Train:Population","Train:Pop_Square","Train:Flight","p_opp")


#not IV
est2_1_gmm = nleqslv(
  fn = function(x) moment(par = x,X = X_lin,Z = X_lin,y = y_),
  x = param0,
)

est2_2_gmm = nleqslv(
  fn = function(x) moment(par = x,X = X_logit,y = y_,Z = X_logit),
  x = param0,
)

est2_3_gmm = nleqslv(
  fn = function(x) moment(par = x,X = X_logit_sp,y = y_,Z = X_logit_sp),
  x = param0,
)


#IV estimator
est2_1_gmm2 = nleqslv(
  fn = function(x) moment(par = x,X = X_lin,y = y_,Z = Z),
  x = param0,
)

est2_2_gmm2 = nleqslv(
  fn = function(x) moment(par = x,X = X_logit,y = y_,Z = Z),
  x = param0,
)

est2_3_gmm2 = nleqslv(
  fn = function(x) moment(par = x,X = X_logit_sp,y = y_,Z = Z),
  x = param0,
)

```


```{r,rows.print = 100}
#moment
tibble(
  var = c(colnames(X_lin),"value"),
  est = c(est2_1_gmm$x,(t(est2_1_gmm$fvec) %*% est2_1_gmm$fvec)[1]),
  se = c(se_moment(est2_1_gmm$x,X_lin,X_lin,y_),NA),
  #value = est2_1$value,
  f_model = "linear",
  s_model = "Moment"
) %>% 
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_2_gmm$x,(t(est2_2_gmm$fvec) %*% est2_2_gmm$fvec)[1]),
      se = c(se_moment(est2_2_gmm$x,X_logit,X_logit,y_),NA),
      #value = est2_2$value,
      f_model = "logit",
      s_model = "Moment"
    )
  ) %>%
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_3_gmm$x,(t(est2_3_gmm$fvec) %*% est2_3_gmm$fvec)[1]),
      se = c(se_moment(est2_3_gmm$x,X_logit_sp,X_logit_sp,y_),NA),
      #value = est2_3$value,
      f_model = "logit_spline",
      s_model = "Moment"
    )
  )  %>% 
  #IV moment
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_1_gmm2$x,(t(est2_1_gmm2$fvec) %*% est2_1_gmm2$fvec)[1]),
      se = c(se_moment(est2_1_gmm2$x,X_logit,X_moments,y_),NA),
      #value = est2_2$value,
      f_model = "linear",
  s_model = "IV_Moment"
    )
  ) %>%  
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_2_gmm2$x,(t(est2_2_gmm2$fvec) %*% est2_2_gmm2$fvec)[1]),
      se = c(se_moment(est2_2_gmm2$x,X_logit,X_moments,y_),NA),
      #value = est2_2$value,
      f_model = "logit",
  s_model = "IV_Moment"
    )
  ) %>% 
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_3_gmm2$x,(t(est2_3_gmm2$fvec) %*% est2_3_gmm2$fvec)[1]),
      se = c(se_moment(est2_3_gmm2$x,X_logit_sp,X_moments,y_),NA),
      #value = est2_3$value,
      f_model = "logit_spline",
  s_model = "IV_Moment"
    )
  ) %>% 
  #OLS
  bind_rows(
    tibble(
      var = names(summary(est1_1)$coefficients[,1]),
      est = summary(est1_1)$coefficients[,1],
      se = summary(est1_1)$coefficients[,2],
      #value = est2_1$value,
      f_model = "linear",
      s_model = "OLS"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est1_2)$coefficients[,1]),
      est = summary(est1_2)$coefficients[,1],
      se = summary(est1_2)$coefficients[,2],
      #value = est2_2$value,
      f_model = "logit",
      s_model = "OLS"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est1_3)$coefficients[,1]),
      est = summary(est1_3)$coefficients[,1],
      se = summary(est1_3)$coefficients[,2],
      #value = est2_3$value,
      f_model = "logit_spline",
      s_model = "OLS"
    )
  ) %>%
  #MLE
  bind_rows(
    tibble(
      var = names(summary(est3_1)$coefficients[,1]),
      est = summary(est3_1)$coefficients[,1],
      se = summary(est3_1)$coefficients[,2],
      #value = est2_1$value,
      f_model = "linear",
      s_model = "MLE"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est3_2)$coefficients[,1]),
      est = summary(est3_2)$coefficients[,1],
      se = summary(est3_2)$coefficients[,2],
      #value = est2_2$value,
      f_model = "logit",
      s_model = "MLE"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est3_3)$coefficients[,1]),
      est = summary(est3_3)$coefficients[,1],
      se = summary(est3_3)$coefficients[,2],
      #value = est2_3$value,
      f_model = "logit_spline",
      s_model = "MLE"
    )
  ) %>%
  filter(var != "value") %>% 
  mutate(var = 
           #English
           case_when(
             var == "Constant" ~ "(Intercept)",
             var == "Distance_Train" ~ "Train:Distance",
             var == "Population_Train" ~ "Train:Population",
             var == "Pop_Square_Train" ~ "Train:Pop_Square",
             var == "Flight_Train" ~ "Train:Flight",
             var %in% c("p_lin_opp","p_logit_opp","p_logit_sp_opp") ~ "Delta",
             TRUE ~ var
           ),
           #Japanese
         var = case_when(
             #var == "Constant" ~ "定数",
             var == "(Intercept)" ~ "定数",
             var == "Distance" ~ "距離",
             var == "Train" ~ "新幹線",
             var == "Population" ~ "人口",
             var == "Pop_Square" ~ "人口2乗",
             var == "Flight" ~ "フライト",
             var == "Delta" ~ "競争",
             var == "Train:Distance" ~ "新幹線:距離",
             var == "Train:Population" ~ "新幹線:人口",
             var == "Train:Pop_Square" ~ "新幹線:人口2乗",
             var == "Train:Flight" ~ "新幹線:フライト",
             TRUE ~ var
           )
         ) %>% 
  pivot_longer(cols = c(est,se),names_to = "type",values_to = "value") %>% 
  mutate(
    #round 2 digits
    #if the last number is 0, make sure to present it
    #if type is se, add ()
    value = ifelse(type == "est",sprintf("%.2f",value),paste0(" (",sprintf("%.2f",value),")")),
  ) %>% 
  pivot_wider(names_from = c(s_model,f_model),values_from = c(value)) %>% 
  mutate( var = ifelse(type == "se","",var)) %>% 
  select(var,
         starts_with("OLS"),
         starts_with("MLE"),
         starts_with("Moment"),
         starts_with("IV")
         # ends_with("linear"),
         #   ends_with("logit"),
         #   ends_with("spline"),
         #   ends_with("linear (IV)"),
         #   ends_with("logit (IV)"),
         #   ends_with("spline (IV)")
         ) %>% 
  bind_rows(
      tibble(
        var = c("Num. obs.","R^2","Log Likelihood"),
        OLS_linear = c(nobs(est1_1),round(summary(est1_1)$r.squared,2),log_lieklihood(est1_1$coefficients)),
        OLS_logit = c(nobs(est1_2),round(summary(est1_2)$r.squared,2),log_lieklihood(est1_2$coefficients)),
        OLS_logit_spline = c(nobs(est1_3),round(summary(est1_3)$r.squared,2),log_lieklihood(est1_3$coefficients)),
        MLE_linear = c(nobs(est3_1),NA,log_lieklihood(est3_1$coefficients)),
        MLE_logit = c(nobs(est3_2),NA,log_lieklihood(est3_2$coefficients)),
        MLE_logit_spline = c(nobs(est3_3),NA,log_lieklihood(est3_3$coefficients)),
        Moment_linear = c(nrow(df_long),NA,log_lieklihood(par = est2_1_gmm$x,f_spec = "p_lin_opp")),
        Moment_logit = c(nrow(df_long),NA,log_lieklihood(est2_2_gmm$x,f_spec = "p_logit_opp")),
        Moment_logit_spline = c(nrow(df_long),NA,log_lieklihood(est2_3_gmm$x,f_spec = "p_logit_sp_opp")),
        IV_Moment_linear = c(nrow(df_long),NA,log_lieklihood(est2_1_gmm2$x,f_spec = "p_lin_opp")),
        IV_Moment_logit = c(nrow(df_long),NA,log_lieklihood(est2_2_gmm2$x,f_spec = "p_logit_opp")),
        IV_Moment_logit_spline = c(nrow(df_long),NA,log_lieklihood(est2_3_gmm2$x,f_spec = "p_logit_sp_opp"))
    ) %>% 
      mutate(
        across(c(-var), ~  ifelse(var == "Num. obs.",as.character(.x),sprintf("%.2f",.x)))
      )
    ) %>% 
  write.csv("../../output/推定テーブル_日本語.csv",row.names=FALSE)

read.csv("../../output/推定テーブル_英語.csv")
  select(-ends_with("spline")) %>% 
  xtable::xtable(caption="Estimation results") %>% 
  print(include.rownames=FALSE)


```

## 3. MLE
```{r}
#linear
est3_1 = df_long %>%
  glm(y ~ Train*(Distance + Population + Pop_Square + Flight) + p_lin_opp,
      #logit
      family = binomial(link = "logit"),data = .)


#logit
est3_2 = df_long %>%
  glm(y ~  Train*(Distance + Population + Pop_Square + Flight) + p_logit_opp,
      #logit
      family = binomial(link = "logit"),data = .)

#logit with spline
est3_3 = df_long %>%
   glm(y ~ Train*(Distance + Population + Pop_Square + Flight) + p_logit_sp_opp,
      #logit
      family = binomial(link = "logit"),data = .)

texreg::screenreg(list(est3_1,est3_2,est3_3),
                  #custom.header = list("y_ANA" = 1:2, "y_JAL" = 3:4),
                   custom.model.names = c("linear","logit","logit with spline"),
                  #variable name
                  custom.coef.map = list("(Intercept)" = NA,"Distance" = NA,"Train" = NA,
                                      "Population" = NA,"Flight" = NA,"Pop_Square" = NA,
                                      "Train:Distance" = NA,"Train:Population" = NA,"Train:Flight" = NA,"Train:Pop_Square" = NA,
                                      "p_lin_opp" = "Delta","p_logit_opp" = "Delta","p_logit_sp_opp" = "Delta"))
```


```{r}
#english
texreg::texreg(list(est1_1,est1_2,#est1_3,
                       est3_1,est3_2#,est3_3
                       ),
                  custom.header = list("OLS (y = Pi)" = 1:2, "MLE (y = action)" = 3:4),
                   custom.model.names = c("linear","logit",#"logit with spline",
                                          "linear","logit"#,"logit with spline"
                                          ),
                  #variable name
                  custom.coef.map = list("(Intercept)" = NA,"Distance" = NA,"Train" = NA,
                                      "Population" = NA,"Flight" = NA,"Pop_Square" = NA,
                                      "Train:Distance" = NA,"Train:Population" = NA,"Train:Flight" = NA,"Train:Pop_Square" = NA,
                                      "p_lin_opp" = "Delta","p_logit_opp" = "Delta","p_logit_sp_opp" = "Delta"))

log_lieklihood(est1_1);log_lieklihood(est1_2)#;log_lieklihood(est1_3)
```
```{r}
#japanese
texreg::texreg(list(est1_1,est1_2,#est1_3,
                       est3_1,est3_2#,est3_3
                       ),
                  custom.header = list("OLS (y = Pi)" = 1:2, "MLE (y = action)" = 3:4),
                   custom.model.names = c("linear","logit",#"logit with spline",
                                          "linear","logit"#,"logit with spline"
                                          ),
                  #variable name
                  custom.coef.map = list("(Intercept)" = "コンスタント" ,"Distance" = "距離","Train" = "新幹線",
                                      "Population" = "人口","Pop_Square" = "人口2乗","Flight" = "フライト",
                                      "Train:Distance" = "新幹線:距離","Train:Population" = "新幹線:人口","Train:Pop_Square" = "新幹線:人口2乗",
                                      "Train:Flight" = "新幹線:フライト",
                                      "p_lin_opp" = "競争","p_logit_opp" = "競争","p_logit_sp_opp" = "競争")
               )
```


```{r}

predict_p = function(par,f_spec = NA){
  
  #par = est$coefficients
  which_p = grepl("^p_",names(par))
  
  if(!is.na(f_spec)){
    p_name = f_spec
  } else{
    p_name = names(par)[which_p]
  }
  
  #order according to X
  par = c(par["(Intercept)"],par["Distance"],par["Population"],par["Pop_Square"],par["Train"],par["Flight"],
    par["Train:Distance"],par["Train:Population"],par["Train:Flight"],par["Train:Pop_Square"],par[which_p])
  
  
  
  X = df_long %>% 
    select(Constant, Distance , Population , Pop_Square , Train , Flight , Distance_Train, Population_Train, 
           Flight_Train, Pop_Square_Train,any_of(p_name)) %>%
    as.matrix()
  
  p = 1/(1 + exp(- X %*% par))
  p = p %>% as.vector
  return(p)
  
}

log_lieklihood = function(par,f_spec = NA){
  p = predict_p(par,f_spec)
  y = df_long$y
  
  likelihood = y*log(p) + (1-y)*log(1-p)
  return(sum(likelihood))
}

#english
texreg::texreg(list(est1_1,est1_2,#est1_3,
                       est3_1,est3_2#,est3_3
                       ),
                  custom.header = list("OLS (y = Pi)" = 1:2, "MLE (y = action)" = 3:4),
                   custom.model.names = c("linear","logit",#"logit with spline",
                                          "linear","logit"#,"logit with spline"
                                          ),
                  #variable name
                  custom.coef.map = list("(Intercept)" = NA,"Distance" = NA,"Train" = NA,
                                      "Population" = NA,"Flight" = NA,"Pop_Square" = NA,
                                      "Train:Distance" = NA,"Train:Population" = NA,"Train:Flight" = NA,"Train:Pop_Square" = NA,
                                      "p_lin_opp" = "Delta","p_logit_opp" = "Delta","p_logit_sp_opp" = "Delta"))

log_lieklihood(est1_1);log_lieklihood(est1_2)#;log_lieklihood(est1_3)
```
```{r}
#japanese
texreg::texreg(list(est1_1,est1_2,#est1_3,
                       est3_1,est3_2#,est3_3
                       ),
                  custom.header = list("OLS (y = Pi)" = 1:2, "MLE (y = action)" = 3:4),
                   custom.model.names = c("linear","logit",#"logit with spline",
                                          "linear","logit"#,"logit with spline"
                                          ),
                  #variable name
                  custom.coef.map = list("(Intercept)" = "定数" ,"Distance" = "距離","Train" = "新幹線",
                                      "Population" = "人口","Pop_Square" = "人口2乗","Flight" = "フライト",
                                      "Train:Distance" = "新幹線:距離","Train:Population" = "新幹線:人口","Train:Pop_Square" = "新幹線:人口2乗",
                                      "Train:Flight" = "新幹線:フライト",
                                      "p_lin_opp" = "競争","p_logit_opp" = "競争","p_logit_sp_opp" = "競争")
               )
```





```{r,rows.print = 12}
#moment
tibble(
  var = c(colnames(X_lin),"value"),
  est = c(est2_1_gmm$x,(t(est2_1_gmm$fvec) %*% est2_1_gmm$fvec)[1]),
  se = c(se_moment(y_,est2_1_gmm$x,X_lin,X_lin),NA),
  #value = est2_1$value,
  f_model = "linear",
  s_model = "Moment"
) %>% 
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_2_gmm$x,(t(est2_2_gmm$fvec) %*% est2_2_gmm$fvec)[1]),
      se = c(se_moment(y_,est2_2_gmm$x,X_logit,X_logit),NA),
      #value = est2_2$value,
      f_model = "logit",
      s_model = "Moment"
    )
  ) %>%
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_3_gmm$x,(t(est2_3_gmm$fvec) %*% est2_3_gmm$fvec)[1]),
      se = c(se_moment(y_,est2_3_gmm$x,X_logit_sp,X_logit_sp),NA),
      #value = est2_3$value,
      f_model = "logit_spline",
      s_model = "Moment"
    )
  )  %>% 
  #IV moment
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_1_gmm2$x,(t(est2_1_gmm2$fvec) %*% est2_1_gmm2$fvec)[1]),
      se = c(se_moment(y_,est2_1_gmm2$x,X_logit,Z),NA),
      #value = est2_2$value,
      f_model = "linear",
  s_model = "IV_Moment"
    )
  ) %>%  
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_2_gmm2$x,(t(est2_2_gmm2$fvec) %*% est2_2_gmm2$fvec)[1]),
      se = c(se_moment(y_,est2_2_gmm2$x,X_logit,Z),NA),
      #value = est2_2$value,
      f_model = "logit",
  s_model = "IV_Moment"
    )
  ) %>% 
  bind_rows(
    tibble(
      var = c(colnames(X_lin),"value"),
      est = c(est2_3_gmm2$x,(t(est2_3_gmm2$fvec) %*% est2_3_gmm2$fvec)[1]),
      se = c(se_moment(y_,est2_3_gmm2$x,X_logit_sp,Z),NA),
      #value = est2_3$value,
      f_model = "logit_spline",
  s_model = "IV_Moment"
    )
  ) %>% 
  #OLS
  bind_rows(
    tibble(
      var = names(summary(est1_1)$coefficients[,1]),
      est = summary(est1_1)$coefficients[,1],
      se = summary(est1_1)$coefficients[,2],
      #value = est2_1$value,
      f_model = "linear",
      s_model = "OLS"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est1_2)$coefficients[,1]),
      est = summary(est1_2)$coefficients[,1],
      se = summary(est1_2)$coefficients[,2],
      #value = est2_2$value,
      f_model = "logit",
      s_model = "OLS"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est1_3)$coefficients[,1]),
      est = summary(est1_3)$coefficients[,1],
      se = summary(est1_3)$coefficients[,2],
      #value = est2_3$value,
      f_model = "logit_spline",
      s_model = "OLS"
    )
  ) %>%
  #MLE
  bind_rows(
    tibble(
      var = names(summary(est3_1)$coefficients[,1]),
      est = summary(est3_1)$coefficients[,1],
      se = summary(est3_1)$coefficients[,2],
      #value = est2_1$value,
      f_model = "linear",
      s_model = "MLE"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est3_2)$coefficients[,1]),
      est = summary(est3_2)$coefficients[,1],
      se = summary(est3_2)$coefficients[,2],
      #value = est2_2$value,
      f_model = "logit",
      s_model = "MLE"
    )
  ) %>%
  bind_rows(
    tibble(
      var = names(summary(est3_3)$coefficients[,1]),
      est = summary(est3_3)$coefficients[,1],
      se = summary(est3_3)$coefficients[,2],
      #value = est2_3$value,
      f_model = "logit_spline",
      s_model = "MLE"
    )
  ) %>%
  filter(var != "value") %>% 
  mutate(var = 
           #English
           case_when(
             var == "Constant" ~ "(Intercept)",
             var == "Distance_Train" ~ "Train:Distance",
             var == "Population_Train" ~ "Train:Population",
             var == "Pop_Square_Train" ~ "Train:Pop_Square",
             var == "Flight_Train" ~ "Train:Flight",
             var %in% c("p_lin_opp","p_logit_opp","p_logit_sp_opp") ~ "Delta",
             TRUE ~ var
           ),
           #Japanese
         var = case_when(
             #var == "Constant" ~ "定数",
             var == "(Intercept)" ~ "定数",
             var == "Distance" ~ "距離",
             var == "Train" ~ "新幹線",
             var == "Population" ~ "人口",
             var == "Pop_Square" ~ "人口2乗",
             var == "Flight" ~ "フライト",
             var == "Delta" ~ "競争",
             var == "Train:Distance" ~ "新幹線:距離",
             var == "Train:Population" ~ "新幹線:人口",
             var == "Train:Pop_Square" ~ "新幹線:人口2乗",
             var == "Train:Flight" ~ "新幹線:フライト",
             TRUE ~ var
           )
         ) %>% 
  pivot_longer(cols = c(est,se),names_to = "type",values_to = "value") %>% 
  mutate(
    #round 2 digits
    #if the last number is 0, make sure to present it
    #if type is se, add ()
    value = ifelse(type == "est",sprintf("%.2f",value),paste0(" (",sprintf("%.2f",value),")")),
  ) %>% 
  pivot_wider(names_from = c(s_model,f_model),values_from = c(value)) %>% 
  mutate( var = ifelse(type == "se","",var)) %>% 
  select(var,
         starts_with("OLS"),
         starts_with("MLE"),
         starts_with("Moment"),
         starts_with("IV")
         # ends_with("linear"),
         #   ends_with("logit"),
         #   ends_with("spline"),
         #   ends_with("linear (IV)"),
         #   ends_with("logit (IV)"),
         #   ends_with("spline (IV)")
         ) %>% 
  bind_rows(
      tibble(
        var = c("Num. obs.","R^2","Log Likelihood"),
        OLS_linear = c(nobs(est1_1),round(summary(est1_1)$r.squared,2),log_lieklihood(est1_1$coefficients)),
        OLS_logit = c(nobs(est1_2),round(summary(est1_2)$r.squared,2),log_lieklihood(est1_2$coefficients)),
        OLS_logit_spline = c(nobs(est1_3),round(summary(est1_3)$r.squared,2),log_lieklihood(est1_3$coefficients)),
        MLE_linear = c(nobs(est3_1),NA,log_lieklihood(est3_1$coefficients)),
        MLE_logit = c(nobs(est3_2),NA,log_lieklihood(est3_2$coefficients)),
        MLE_logit_spline = c(nobs(est3_3),NA,log_lieklihood(est3_3$coefficients)),
        Moment_linear = c(nrow(df_long),NA,log_lieklihood(par = est2_1_gmm$x,f_spec = "p_lin_opp")),
        Moment_logit = c(nrow(df_long),NA,log_lieklihood(est2_2_gmm$x,f_spec = "p_logit_opp")),
        Moment_logit_spline = c(nrow(df_long),NA,log_lieklihood(est2_3_gmm$x,f_spec = "p_logit_sp_opp")),
        IV_Moment_linear = c(nrow(df_long),NA,log_lieklihood(est2_1_gmm2$x,f_spec = "p_lin_opp")),
        IV_Moment_logit = c(nrow(df_long),NA,log_lieklihood(est2_2_gmm2$x,f_spec = "p_logit_opp")),
        IV_Moment_logit_spline = c(nrow(df_long),NA,log_lieklihood(est2_3_gmm2$x,f_spec = "p_logit_sp_opp"))
    ) %>% 
      mutate(
        across(c(-var), ~  ifelse(var == "Num. obs.",as.character(.x),sprintf("%.2f",.x)))
      )
    ) %>% 
  write.csv("../../output/推定テーブル_日本語.csv")

read.csv("../../output/推定テーブル_英語.csv") %>%
  select(-ends_with("spline")) %>% 
  xtable::xtable(caption="Estimation results") %>% 
  print(include.rownames=FALSE)


```



# equilibrium compuation
```{r}
FOC = function(p_opp,par,X){
  #description: returns best response for all markets　 
  #input: p_opp (J vector), par, X (J x K matrix, does not include p_opp)
  #output: best response p (J vector)
  
  X = cbind(X,p_opp)
  p = 1/(1 + exp(- X %*% par))
  p = p %>% as.vector
  return(p)
}

FOC_opp = function(p_opp,par,X){
  #description: returns best response for all markets　 
  #input: p_opp (J vector), par, X (J x K matrix, does not include p_opp)
  #output: best response p (J vector)
  
  n_market = nrow(X)/2
  p = FOC(p_opp,par,X)
  p_opp = c(p[(n_market + 1):(2*n_market)],p[1:n_market])
  return(p_opp)
}

equilbrium = function(p_init,par,X,tol = 1e-6, max_iter = 1000){
  #description: repeatedly calculates best response until convergence
  
  n_market = nrow(X)/2
  p_opp = c(p_init[(n_market + 1):(2*n_market)],p_init[1:n_market])
  
  for (i in 1:max_iter){
    p_opp_new = FOC_opp(p_opp,par,X)
    if (sum((p_opp_new - p_opp)^2) < tol){
      break
    }
    p_opp = p_opp_new
  }
  p_eq = c(p_opp[(n_market + 1):(2*n_market)],p_opp[1:n_market])
  return(p_eq)
}


equilbrium_market = function(ids,optimal,par,df_long = df_long){
  #optimal \in {ANA,JAL}
  
  X = df_long %>% 
    #arrange(comp) %>% #ANA first
    filter(id %in% ids) %>% 
    # mutate(Train_Distance = Train * Distance,
    #        Train_Population = Train * Population,
    #        Train_Flight = Train * Flight,
    #        Train_Pop_Square = Train * Pop_Square) %>%
    select(Constant, Distance , Population , Pop_Square , Train , Flight , Distance_Train, Population_Train, Flight_Train, Pop_Square_Train) %>%
    as.matrix()

  #par = est$coefficients
  
  #order according to X
  par = c(par["(Intercept)"],par["Distance"],par["Population"],par["Pop_Square"],par["Train"],par["Flight"],
    par["Train:Distance"],par["Train:Population"],par["Train:Flight"],par["Train:Pop_Square"],par[grepl("^p_",names(par))])
  
  
  
  n_market = nrow(X)/2
  if (optimal == "ANA"){
    p_init = c(rep(1,n_market),rep(0,n_market)) #initial guess (ANA:p = 1, JAL:p = 0) (ANA optimal)
  }else{
    p_init = c(rep(0,n_market),rep(1,n_market)) #initial guess (ANA:p = 0, JAL:p = 1) (JAL optimal)
  }
  
  p_eq = equilbrium(p_init,par,X)
  return(p_eq)
}


library(tictoc)

df_long = df_long %>% 
  arrange(comp)


```


# equilibrium multiplicity & model fit of 1st stage
```{r}
#est2_2_gmm2
df_long = df_long %>% 
  mutate(
    new_eq_ana = equilbrium_market(unique(df$id),"ANA",est2_2_gmm2$x,df_long = df_long),
    new_eq_jal = equilbrium_market(unique(df$id),"JAL",est2_2_gmm2$x,df_long = df_long),
    dif = abs(new_eq_ana - new_eq_jal)
  )

df_long %>% 
  ggplot()+
  geom_point(aes(x = new_eq_ana,y = new_eq_jal,color = dif))+
  geom_abline(intercept = 0,slope = 1)+
  scale_color_gradient2(low = "blue",high = "red",
                       midpoint = .01)+
  facet_wrap(~comp)+
  theme_minimal()
```
```{r}
df_long %>% 
  select(id,comp,new_eq_jal,p_lin_opp) %>% 
  pivot_wider(names_from = comp,values_from = c(new_eq_jal,p_lin_opp)) %>%
  rename(ANA_eq = new_eq_jal_ANA,JAL_eq = new_eq_jal_JAL,JAL_p_1st = p_lin_opp_ANA,ANA_p_1st = p_lin_opp_JAL) %>% 
  pivot_longer(cols = c(ANA_eq,JAL_eq),names_to = "comp",values_to = "eq") %>% 
  pivot_longer(cols = c(JAL_p_1st,ANA_p_1st),names_to = "comp_1st",values_to = "p_1st") %>% 
  mutate(comp = str_replace(comp,"_eq",""),
         comp_1st = str_replace(comp_1st,"_p_1st","")) %>%
  filter(comp == comp_1st) %>% 
  left_join(
    df_long %>% 
      mutate(p_2nd = predict_p(est1_2)) %>% 
      select(id,comp,p_2nd),by = c("id","comp")
  ) %>%
  pivot_longer(cols = c(p_2nd,p_1st),names_to = "p_name",values_to = "p_value") %>% 
  ggplot()+
  geom_point(aes(x = eq,y = p_value,color = abs(p_value - eq)))+
  geom_abline(intercept = 0,slope = 1)+
  scale_color_gradient(low = "blue",high = "red")+
  facet_wrap(p_name~comp)+
  theme_minimal()
```

# counterfactual: 北陸新幹線の通る空港
```{r}
# id_port_map %>% 
#   mutate(
#     hokuriku = case_when(
#       Port == "小松" ~ 1,
#       Port == "富山" ~ 1,
#       Port == "松本" ~ 1,
#       Port == "羽田" ~ 1,
#       Port == "伊丹" ~ 1,
#       #Port == "能登" ~ 1,
#       TRUE ~ 0
#     )
#   )

id_port_dyad_long = id_port_dyad_long %>% 
  mutate(
    hokuriku = case_when(
      port1 %in% c("小松","富山","松本","羽田") & port2 %in% c("小松","富山","松本","羽田") ~ 1,
      TRUE ~ 0
    )
  ) 



```

```{r}
#counterfactual2 including 伊丹
df_long = df_long %>% 
  left_join(id_port_dyad_long,by = "id") %>% 
  relocate(id,dyad,port1,port2,hokuriku,y)

df_long_hokuriku = df_long %>% 
  mutate(
    hokuriku = case_when(
      port1 %in% c("小松","富山","松本","羽田","伊丹") & port2 %in% c("小松","富山","松本","羽田","伊丹") ~ 1,
      TRUE ~ 0
    )
  ) %>% 
  mutate(Train_orig = Train,
         Train = pmin(1,Train + hokuriku),
         Distance_Train = Distance*Train,
         Population_Train = Population*Train,
         Pop_Square_Train = Pop_Square*Train,
         Flight_Train = Flight*Train)


df_long_hokuriku = df_long_hokuriku %>% 
  mutate(
    orig_eq_ana = equilbrium_market(unique(df$id),"ANA",est3_2$coefficients,#est1_2$coefficients,est2_2_gmm2$x,
                                   df_long = df_long),
    orig_eq_jal = equilbrium_market(unique(df$id),"JAL",est3_2$coefficients,#est1_2$coefficients,,est2_2_gmm2$x,
                                   df_long = df_long),
    hoku_eq_ana = equilbrium_market(unique(df$id),"ANA",est3_2$coefficients,#est1_2$coefficients,,est2_2_gmm2$x,
                                   df_long = df_long_hokuriku),
    hoku_eq_jal = equilbrium_market(unique(df$id),"JAL",est3_2$coefficients,#est1_2$coefficients,,est2_2_gmm2$x,
                                   df_long = df_long_hokuriku)
  )
```

```{r}
df_long_hokuriku %>% 
  filter(hokuriku == 1) %>% 
  mutate(port1_b = str_sub(dyad,regexpr("_",dyad)+1,nchar(dyad)),
         port2_b = str_sub(dyad,1,regexpr("_",dyad)-1)) %>% 
  pivot_longer(c(port1,port1_b),values_to = "port1") %>% 
  mutate(port2 = ifelse(name == "port1",port2,port2_b)) %>% 
  pivot_longer(c(orig_eq_ana,hoku_eq_ana),values_to = "eq",names_to = "counterfactual") %>%
  bind_rows(
    expand_grid(
      tibble(port1 = port_order,
           port2 = port_order),
      eq = NA,
      counterfactual = c("orig_eq_ana","hoku_eq_ana"),
      comp = c("ANA","JAL")
    )%>% 
      mutate(hokuriku = case_when(
          port1 %in% c("小松","富山","松本","羽田","伊丹") & port2 %in% c("小松","富山","松本","羽田","伊丹") ~ 1,
          TRUE ~ 0
        ))
  ) %>%
  filter(hokuriku == 1) %>% 
  mutate(#equil = ifelse(str_detect(name_eq,"_l"), "largest", "smallest"),
         #counterfactual = ifelse(str_detect(name_eq,"orig"), "Original", "Hokuriku"),
         port1 = factor(port1,levels = port_order),
         port1_id = as.numeric(factor(port1,levels = port_order)),
         port2 = factor(port2,levels = port_order),
         port2_id = as.numeric(factor(port2,levels = port_order)),
         eq = ifelse(port1_id >= port2_id,eq,NA),
         counterfactual = ifelse(counterfactual == "orig_eq_ana","original","hokuriku_shinkansen"),
         counterfactual = factor(counterfactual,levels = c("original","hokuriku_shinkansen")),
         ) %>%
  ggplot(aes(port1, port2, fill= eq)) + 
  geom_tile(color = "white") +
  facet_wrap(counterfactual~comp,labeller = labeller(counterfactual = 
    c("original" = "北陸新幹線なし",
      "hokuriku_shinkansen" = "北陸新幹線あり")
  )) +
  labs(x = "", y = "") +
  #legend name
  scale_fill_gradient2(name = "均衡参入確率") + #,low = "white",mid = "yellow",high = "red", midpoint = 0.5
  theme_gray (base_family = "HiraKakuPro-W3")

ggsave("fig/hokuriku_heatmap_MLE_logit.png",width = 10,height = 5)
```
```{r}
df_long_hokuriku %>% 
  filter(hokuriku == 1) %>% 
  select(dyad,comp,orig_eq_ana,hoku_eq_ana) %>% 
  rename("ルート" = dyad,"企業" = comp,
         "北陸新幹線あり" = hoku_eq_ana,"北陸新幹線なし" = orig_eq_ana) %>% 
  pivot_wider(names_from = "企業",values_from = c("北陸新幹線あり","北陸新幹線なし")) %>% 
  relocate(ルート,北陸新幹線なし_ANA,北陸新幹線あり_ANA,北陸新幹線なし_JAL,北陸新幹線あり_JAL) %>% 
  #write latex table
  xtable::xtable(caption="反実仮想") %>% 
  print(include.rownames=FALSE)
```
